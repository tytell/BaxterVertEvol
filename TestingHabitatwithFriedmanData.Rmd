---
title: "TestingHabitatwithFriedmanData"
output:
  html_document:
    df_print: paged
  html_notebook: default
  pdf_document: default
  word_document: default
---

```{r}
library(rfishbase)
library(tidyverse)
library (ggplot2)
library(Hmisc)
library(phytools)
library(here)
library(ape)
library(geiger)
library(nlme)
library(patchwork)
library(emmeans)
library(multcompView)
library(readxl)
library(plotly) 
library(ggthemes) 
library(naniar)
library(dplyr)
```


#Load in csv
```{r}
vertmeasall <- read.csv("MasterVert_Measurements.csv")
vertmeasall
```


#Take Mean of Vert Measurements 
```{r}
vertmeasallmean <- vertmeasall %>%
  group_by(Species, Indiv) %>%
  select(SL, CBL, d, alpha_Pos, alpha_Ant, D_Pos, D_Ant) %>%
  summarize_all(mean, na.rm=TRUE) %>%
  ungroup()

vertmeasallmean
```


#Merge with Habitat Columns
```{r}
verthabitat <- read.csv("VertHabitatR.csv")

verthabitat
```

```{r}
vertmeasallmeanhabitat <-
  left_join(
  vertmeasallmean,
  
  verthabitat,
  
  by = "Species")

vertmeasallmeanhabitat
```


#Plots with Habitat_Friedman
```{r}
ggplot(vertmeasallmeanhabitat, aes(x = d, y = CBL, color = Habitat_Friedman)) + 
  geom_point()
```


```{r}
ggplot(vertmeasallmeanhabitat, aes(x = d, y = D_Pos, color = Habitat_Friedman)) + 
  geom_point()
```

```{r}
ggplot(vertmeasallmeanhabitat, aes(x = d, y = CBL, color = Habitat_FishBase)) + 
  geom_point()
```


```{r}
ggplot(vertmeasallmeanhabitat, aes(x = Habitat_Friedman, y = d, color=Habitat_Friedman)) +
  stat_summary(fun.data = "mean_cl_boot") +
  geom_point(position ="jitter", alpha=0.5)
```


```{r}
ggplot(vertmeasallmeanhabitat, aes(x = Habitat_Friedman, y = CBL, color=Habitat_Friedman)) +
  stat_summary(fun.data = "mean_cl_boot") +
  geom_point(position ="jitter", alpha=0.5)
```

#Try PGLS with the Friedman Habitat Data

#Load in Phylogenetic Info
```{r}
treefile <- '12862_2017_958_MOESM2_ESM.tre'
```


```{r}
tree <- read.tree(here('..', treefile))
```


```{r}
plotTree(tree)
```


```{r}
# first just get the tip labels. These look Family_Genus_Species_Code
allspecies <- as.data.frame(tree$tip.label, stringsAsFactors = FALSE) 
colnames(allspecies) <- c('FullName')

# split the label into columns on the underscores, but then merge genus and species again into
# a binomial separated by a space
allspecies <- 
  allspecies %>% separate(FullName, sep='_', into=c('Family', 'Genus', 'Species'), 
                          extra='drop', remove=FALSE)

# add in the tip number, which is just 1 to the number of species
allspecies$Tip <- seq_len(nrow(allspecies))
```


```{r}
vertmeasall
```


```{r}
vertmeasall %>%
  group_by(Species, Body.Shape, Habitat_Friedman) %>%
  summarise(d = mean(d),
            CBL = mean(CBL)) %>%
  ungroup() %>%
  separate(Species, sep='_', into=c("Genus", "Species")) ->
  vertmeas.species
```


```{r}
vertmeas.species <- left_join(vertmeas.species, allspecies, by=c("Genus", "Species"))
vertmeas.species
```


```{r}
left_join(filter(vertmeas.species, is.na(Tip)),
          distinct(allspecies, Genus, .keep_all=TRUE), by=c("Genus")) %>%
  transmute(Genus=Genus, Species=Species.x, Family=Family.y, MatchSpecies=Species.y, Tip=Tip.y) ->
  vertmeas.bygenus
```


```{r}
vertmeas.bygenus
```

```{r}
left_join(vertmeas.species, vertmeas.bygenus,
          by = c("Genus","Species","Family")) %>%
  mutate(Tip = coalesce(Tip.x, Tip.y),
         MatchSpecies = coalesce(MatchSpecies, Species)) %>%
  select(-Tip.x, -Tip.y) %>%
  filter(!is.na(Tip)) ->
  vertmeas.species1
vertmeas.species1
```


```{r}
vertmeas.species1 <- column_to_rownames(vertmeas.species1, var="FullName")
```


```{r}
verttree <- keep.tip(tree, tip=as.vector(vertmeas.species1$Tip))
```


```{r}
plotTree(verttree)
```


#Start PGLS Analysis with Friedman Habitat Data 
```{r}
length(verttree$tip.label)
nrow(vertmeas.species1)
```


```{r}
name.check(verttree, vertmeas.species1)
```


```{r}
pgls_d_BodyShape<- gls(d ~ Body.Shape, correlation = corBrownian(phy = verttree),
                      data = vertmeas.species1, method = "ML")
summary(pgls_d_BodyShape)
anova(pgls_d_BodyShape)
```
Body shape significant here 

```{r}
pgls_CBL_BodyShape<- gls(CBL ~ Body.Shape, correlation = corBrownian(phy = verttree),
                      data = vertmeas.species1, method = "ML")
summary(pgls_CBL_BodyShape)
anova(pgls_CBL_BodyShape)
```


```{r}
p1 <- ggplot(vertmeas.species1, aes(x=Body.Shape, y=d, color=Body.Shape)) +
  geom_point(alpha = 0.5, position = position_jitter(width=0.2)) +
  stat_summary(fun.data = mean_sdl)

p2 <- ggplot(vertmeas.species1, aes(x=Body.Shape, y=CBL, color=Body.Shape)) +
  geom_point(alpha = 0.5, position = position_jitter(width=0.2)) +
  stat_summary(fun.data = mean_sdl)

p1 / p2
```


```{r}
coef(pgls_d_BodyShape)
```


PGLS with Friedman Habitat Data
```{r}
pgls_d_Habitat <- gls(d ~ Habitat_Friedman, correlation = corBrownian(phy = verttree),
                      data = vertmeas.species1, method = "ML")
summary(pgls_d_Habitat)
```
Pelagic is ALMOST significant, but not really. Reef associated is, but there are only like 2 species with this category.

```{r}
pgls_CBL_Habitat <- gls(CBL ~ Habitat_Friedman, correlation = corBrownian(phy = verttree),
                        data = vertmeas.species1, method = "ML")
summary(pgls_CBL_Habitat)
```


```{r}
h1 <- ggplot(vertmeas.species1, aes(x=Habitat_Friedman, y=d, color=Habitat_Friedman)) +
  geom_point(alpha = 0.5, position = position_jitter(width=0.2)) +
  stat_summary(fun.data = mean_sdl)


h2 <- ggplot(vertmeas.species1, aes(x=Habitat_Friedman, y=CBL, color=Habitat_Friedman)) +
  geom_point(alpha = 0.5, position = position_jitter(width=0.2)) + 
  stat_summary(fun.data = mean_sdl)

h1 / h2
```


#Looking at pelagic d outlier
The outlier seems to be Elops saurus. This is an attempt to run the PGLS without Elops saurus to see if anything changes.

```{r}
pglsedit <- vertmeas.species %>% 
  filter(Genus != "Elops") #using dplyr, thanks Ben!

pglsedit
```


```{r}
left_join(filter(pglsedit, is.na(Tip)),
          distinct(allspecies, Genus, .keep_all=TRUE), by=c("Genus")) %>%
  transmute(Genus=Genus, Species=Species.x, Family=Family.y, MatchSpecies=Species.y, Tip=Tip.y) ->
  vertmeas.bygenuspglsedit

vertmeas.bygenuspglsedit
```


```{r}
left_join(pglsedit, vertmeas.bygenuspglsedit,
          by = c("Genus","Species","Family")) %>%
  mutate(Tip = coalesce(Tip.x, Tip.y),
         MatchSpecies = coalesce(MatchSpecies, Species)) %>%
  select(-Tip.x, -Tip.y) %>%
  filter(!is.na(Tip)) ->
  vertmeas.speciespglsedit

vertmeas.speciespglsedit
```


```{r}
vertmeas.speciespglsedit <- column_to_rownames(vertmeas.speciespglsedit, var="FullName")
```


```{r}
verttreepglsedit <- keep.tip(tree, tip=as.vector(vertmeas.speciespglsedit$Tip))
```


```{r}
plotTree(verttreepglsedit)
```


```{r}
length(verttreepglsedit$tip.label)
nrow(vertmeas.speciespglsedit)
```


```{r}
name.check(verttreepglsedit, vertmeas.speciespglsedit)
```


```{r}
pglsedit_d_Habitat <- gls(d ~ Habitat_Friedman, correlation = corBrownian(phy = verttreepglsedit),
                      data = vertmeas.speciespglsedit, method = "ML")
summary(pglsedit_d_Habitat)
anova(pglsedit_d_Habitat)
```


```{r}
pwpm(emmeans(pglsedit_d_Habitat, "Habitat_Friedman"))
```


```{r}
pairs(emmeans(pglsedit_d_Habitat, "Habitat_Friedman"))
```



```{r}
pglsedit_CBL_Habitat <- gls(CBL ~ Habitat_Friedman, correlation = corBrownian(phy = verttreepglsedit),
                        data = vertmeas.speciespglsedit, method = "ML")
summary(pglsedit_CBL_Habitat)
```


```{r}
ha1 <- ggplot(vertmeas.speciespglsedit, aes(x=Habitat_Friedman, y=d, color=Habitat_Friedman)) +
  geom_point(alpha = 0.5, position = position_jitter(width=0.2)) +
  stat_summary(fun.data = mean_sdl)


ha2 <- ggplot(vertmeas.speciespglsedit, aes(x=Habitat_Friedman, y=CBL, color=Habitat_Friedman)) +
  geom_point(alpha = 0.5, position = position_jitter(width=0.2)) + 
  stat_summary(fun.data = mean_sdl)

ha1 / ha2
```



#PGLS with Consensus Habitat Column

```{r}
vertmeasall %>%
  group_by(Species, Body.Shape, Habitat) %>%
  summarise(d = mean(d),
            CBL = mean(CBL),
            D_Pos = mean(D_Pos),
            alpha_Pos = mean(alpha_Pos)) %>%
  ungroup() %>%
  separate(Species, sep='_', into=c("Genus", "Species")) ->
  vertmeas.species
```


```{r}
vertmeas.speciesconsensus <- left_join(vertmeas.species, allspecies, by=c("Genus", "Species"))
vertmeas.speciesconsensus
```


```{r}
left_join(filter(vertmeas.speciesconsensus, is.na(Tip)),
          distinct(allspecies, Genus, .keep_all=TRUE), by=c("Genus")) %>%
  transmute(Genus=Genus, Species=Species.x, Family=Family.y, MatchSpecies=Species.y, Tip=Tip.y) ->
  vertmeas.bygenusconsensus
```


```{r}
vertmeas.bygenusconsensus
```


```{r}
left_join(vertmeas.speciesconsensus, vertmeas.bygenusconsensus,
          by = c("Genus","Species","Family")) %>%
  mutate(Tip = coalesce(Tip.x, Tip.y),
         MatchSpecies = coalesce(MatchSpecies, Species)) %>%
  select(-Tip.x, -Tip.y) %>%
  filter(!is.na(Tip)) ->
  vertmeas.speciesconsensus1
vertmeas.speciesconsensus1
```


```{r}
vertmeas.speciesconsensus1 <- column_to_rownames(vertmeas.speciesconsensus1, var="FullName")
```


```{r}
verttreeconsensus <- keep.tip(tree, tip=as.vector(vertmeas.speciesconsensus1$Tip))
```


```{r}
plotTree(verttreeconsensus)
```

```{r}
length(verttreeconsensus$tip.label)
nrow(vertmeas.speciesconsensus1)
```


```{r}
name.check(verttreeconsensus, vertmeas.speciesconsensus1)
```


```{r}
pgls_d_HabitatConsensus <- gls(d ~ Habitat, correlation = corBrownian(phy = verttreeconsensus),
                      data = vertmeas.speciesconsensus1, method = "ML")
summary(pgls_d_HabitatConsensus)
```

```{r}
anova(pgls_d_HabitatConsensus)
```


```{r}
pgls_CBL_HabitatConsensus <- gls(CBL ~ Habitat, correlation = corBrownian(phy = verttreeconsensus),
                        data = vertmeas.speciesconsensus1, method = "ML")
summary(pgls_CBL_HabitatConsensus)
```

```{r}
anova(pgls_CBL_HabitatConsensus)
```

```{r}
hc1 <- ggplot(vertmeas.speciesconsensus1, aes(x=Habitat, y=d, color=Habitat)) +
  geom_point(alpha = 0.5, position = position_jitter(width=0.2)) +
  stat_summary(fun.data = mean_sdl)


hc2 <- ggplot(vertmeas.speciesconsensus1, aes(x=Habitat, y=CBL, color=Habitat)) +
  geom_point(alpha = 0.5, position = position_jitter(width=0.2)) + 
  stat_summary(fun.data = mean_sdl)

hc1 / hc2
```


```{r}
pwpm(emmeans(pgls_d_HabitatConsensus, "Habitat"))
```


```{r}
pairs(emmeans(pgls_d_HabitatConsensus, "Habitat"))
```

#Mean PGLS with D_Pos and habitat consensus

```{r}
pgls_DPos_HabitatConsensus <- gls(D_Pos ~ Habitat, correlation = corBrownian(phy = verttreeconsensus),
                      data = vertmeas.speciesconsensus1, method = "ML")
summary(pgls_DPos_HabitatConsensus)
```

```{r}
anova(pgls_DPos_HabitatConsensus)
```

```{r}
pairs(emmeans(pgls_DPos_HabitatConsensus, "Habitat"))
```

#Mean PGLS with alpha_Pos and Habitat Consensus

```{r}
pgls_alphaPos_HabitatConsensus <- gls(alpha_Pos ~ Habitat, correlation = corBrownian(phy = verttreeconsensus),
                      data = vertmeas.speciesconsensus1, method = "ML")
summary(pgls_alphaPos_HabitatConsensus)
```

```{r}
anova(pgls_alphaPos_HabitatConsensus)
```

```{r}
pairs(emmeans(pgls_alphaPos_HabitatConsensus, "Habitat"))
```



#Consensus Habitat Attempt without Elops saurus
The outlier seems to be Elops saurus. This is an attempt to run the PGLS without Elops saurus to see if anything changes.

```{r}
pglseditconsensus <- vertmeas.speciesconsensus %>% 
  filter(Genus != "Elops") #using dplyr, thanks Ben!

pglseditconsensus
```


```{r}
left_join(filter(pglseditconsensus, is.na(Tip)),
          distinct(allspecies, Genus, .keep_all=TRUE), by=c("Genus")) %>%
  transmute(Genus=Genus, Species=Species.x, Family=Family.y, MatchSpecies=Species.y, Tip=Tip.y) ->
  vertmeas.bygenuspglseditconsensus

vertmeas.bygenuspglseditconsensus
```

```{r}
left_join(pglseditconsensus, vertmeas.bygenuspglseditconsensus,
          by = c("Genus","Species","Family")) %>%
  mutate(Tip = coalesce(Tip.x, Tip.y),
         MatchSpecies = coalesce(MatchSpecies, Species)) %>%
  select(-Tip.x, -Tip.y) %>%
  filter(!is.na(Tip)) ->
  vertmeas.speciespglseditconsensus

vertmeas.speciespglseditconsensus
```


```{r}
vertmeas.speciespglseditconsensus <- column_to_rownames(vertmeas.speciespglseditconsensus, var="FullName")
```


```{r}
verttreepglseditconsensus <- keep.tip(tree, tip=as.vector(vertmeas.speciespglseditconsensus$Tip))
```


```{r}
plotTree(verttreepglseditconsensus)
```


```{r}
length(verttreepglseditconsensus$tip.label)
nrow(vertmeas.speciespglseditconsensus)
```


```{r}
name.check(verttreepglseditconsensus, vertmeas.speciespglseditconsensus)
```


```{r}
pglsedit_d_HabitatConsensus <- gls(d ~ Habitat, correlation = corBrownian(phy = verttreepglseditconsensus),
                      data = vertmeas.speciespglseditconsensus, method = "ML")
summary(pglsedit_d_HabitatConsensus)
```

```{r}
anova(pglsedit_d_HabitatConsensus)
```


```{r}
pwpm(emmeans(pglsedit_d_HabitatConsensus, "Habitat"))
```


```{r}
pairs(emmeans(pglsedit_d_HabitatConsensus, "Habitat"))
```


#Max d with Consensus Habitat

```{r}
vertmeasallmax <- vertmeasall %>%
  group_by(Species, Indiv) %>%
  select(SL, CBL, d, alpha_Pos, alpha_Ant, D_Pos, D_Ant) %>%
  summarize_all(mean, na.rm=TRUE) %>%
  ungroup()

vertmeasallmax

#taking max d for each species 
```

```{r}
vertmeasallmaxhabitat <-
  left_join(
  vertmeasallmax,
  
  verthabitat,
  
  by = "Species")

vertmeasallmaxhabitat

#merge with habitat columns 
```

```{r}
vertmeasall %>%
  group_by(Species, Body.Shape, Habitat) %>%
  summarise(d = max(d),
            CBL = max(CBL),
            D_Ant = max(D_Ant),
            D_Pos = max(D_Pos),
            alpha_Pos = max(alpha_Pos),
            alpha_Ant = max(alpha_Ant)) %>%
  ungroup() %>%
  separate(Species, sep='_', into=c("Genus", "Species")) ->
  vertmeas.speciesmax
```


```{r}
vertmeas.speciesmax <- left_join(vertmeas.speciesmax, allspecies, by=c("Genus", "Species"))

vertmeas.speciesmax
```

```{r}
left_join(filter(vertmeas.speciesmax, is.na(Tip)),
          distinct(allspecies, Genus, .keep_all=TRUE), by=c("Genus")) %>%
  transmute(Genus=Genus, Species=Species.x, Family=Family.y, MatchSpecies=Species.y, Tip=Tip.y) ->
  vertmeas.bygenusmax
```


```{r}
vertmeas.bygenusmax
```

```{r}
left_join(vertmeas.speciesmax, vertmeas.bygenusmax,
          by = c("Genus","Species","Family")) %>%
  mutate(Tip = coalesce(Tip.x, Tip.y),
         MatchSpecies = coalesce(MatchSpecies, Species)) %>%
  select(-Tip.x, -Tip.y) %>%
  filter(!is.na(Tip)) ->
  vertmeas.speciesmax1
vertmeas.speciesmax1
```


```{r}
vertmeas.speciesmax1 <- column_to_rownames(vertmeas.speciesmax1, var="FullName")
```


```{r}
verttreemax <- keep.tip(tree, tip=as.vector(vertmeas.speciesmax1$Tip))
```


```{r}
plotTree(verttreemax)
```

```{r}
length(verttreemax$tip.label)
nrow(vertmeas.speciesmax1)
```


```{r}
name.check(verttreemax, vertmeas.speciesmax1)
```


```{r}
pgls_d_HabitatConsensusMax<- gls(d ~ Habitat, correlation = corBrownian(phy = verttreemax),
                      data = vertmeas.speciesmax1, method = "ML")
summary(pgls_d_HabitatConsensusMax)
```

```{r}
anova(pgls_d_HabitatConsensusMax)
```

```{r}
pairs(emmeans(pgls_d_HabitatConsensusMax, "Habitat"))
```

#PGLS with max CBL and habitat consensus

```{r}
pgls_CBL_HabitatConsensusMax<- gls(CBL ~ Habitat, correlation = corBrownian(phy = verttreemax),
                      data = vertmeas.speciesmax1, method = "ML")
summary(pgls_CBL_HabitatConsensusMax)
```

```{r}
anova(pgls_CBL_HabitatConsensusMax)
```

```{r}
pairs(emmeans(pgls_CBL_HabitatConsensusMax, "Habitat"))
```

#PGLS with max D_Pos and habitat consensus

```{r}
pgls_DPos_HabitatConsensusMax<- gls(D_Pos ~ Habitat, correlation = corBrownian(phy = verttreemax),
                      data = vertmeas.speciesmax1, method = "ML")
summary(pgls_DPos_HabitatConsensusMax)
```

```{r}
anova(pgls_DPos_HabitatConsensusMax)
```

```{r}
pairs(emmeans(pgls_DPos_HabitatConsensusMax, "Habitat"))
```

#PGLS with max alpha_Pos and habitat consensus

```{r}
pgls_alphaPos_HabitatConsensusMax<- gls(alpha_Pos ~ Habitat, correlation = corBrownian(phy = verttreemax),
                      data = vertmeas.speciesmax1, method = "ML")
summary(pgls_alphaPos_HabitatConsensusMax)
```

```{r}
anova(pgls_alphaPos_HabitatConsensusMax)
```

```{r}
pairs(emmeans(pgls_alphaPos_HabitatConsensusMax, "Habitat"))
```

#PGLS Figures for Habitat Consensus Visualization

```{r}
hc1 <- ggplot(vertmeas.speciesconsensus1, aes(x=Habitat, y=d, color=Habitat)) +
  geom_point(alpha = 0.5, position = position_jitter(width=0.2)) +
  stat_summary(fun.data = mean_sdl)


hcm2 <- ggplot(vertmeas.speciesconsensus1, aes(x=Habitat, y=alpha_Pos, color=Habitat)) +
  geom_point(alpha = 0.5, position = position_jitter(width=0.2)) + 
  stat_summary(fun.data = mean_sdl)

hc1 / hcm2
```



#Output a CSV with all data 

vertmeasall has all of the habitat columns and all of the measurements, but I don't think it's linked the node into the phylogeny. To be honest, I'm not totally sure how to do that. 


```{r}
vertmeasall %>%
  separate(Species, sep='_', into=c("Genus", "Species")) ->
  vertmeas.speciesall
```


```{r}
vertmeas.speciesall <- left_join(vertmeas.speciesall, allspecies, by=c("Genus", "Species"))

vertmeas.speciesall
```


```{r}
left_join(filter(vertmeas.speciesall, is.na(Tip)),
          distinct(allspecies, Genus, .keep_all=TRUE), by=c("Genus")) %>%
  transmute(Genus=Genus, Species=Species.x, Family=Family.y, MatchSpecies=Species.y, Tip=Tip.y) ->
  vertmeas.bygenusall

vertmeas.bygenusall
```

```{r}
left_join(vertmeas.speciesall, vertmeas.bygenusall,
          by = c("Genus","Species","Family")) %>%
  mutate(Tip = coalesce(Tip.x, Tip.y),
         MatchSpecies = coalesce(MatchSpecies, Species)) %>%
  select(-Tip.x, -Tip.y) %>%
  filter(!is.na(Tip)) ->
  vertmeas.speciesall1

vertmeas.speciesall1
```


```{r}
write.csv (vertmeas.speciesall1,"All_Vert_Data.csv")
```
































