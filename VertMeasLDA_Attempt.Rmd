---
title: "Full Vertebral Data LDA"
output: html_notebook
---



```{r}
library(patchwork)
library(FactoMineR)
library(factoextra)
library(GGally)
library(scico)
library(MASS)
library(tidyverse)
library(ggrepel)
```

The resources I'm looking at say that the data need to be one column with a categorical variable (our consensus habitat column) and numeric predictor variables (our measurements, like d_40, CBL_50, etc.). With that being said, I think that all I would maybe have to do for this before running the model would maybe be to make sure that the data look organized in that way?

```{r}
vertdata <- read.csv("All_Vert_Data.csv") %>%
  mutate(Habitat = factor(Habitat, levels=c('benthic','demersal','pelagic')))

vertdata
```

```{r}
allvertdata <- vertdata %>%
  dplyr::select(Genus,Species, Indiv, Body.Shape, Habitat, Tip, Family, FullName, Pos, CBL, d, alpha_Pos, D_Pos, alpha_Ant, D_Ant) %>%
  complete(Pos, nesting(Species, Indiv)) %>%
  arrange(Species, Indiv, Pos) %>%
  rename(alphaPos = alpha_Pos,
         DPos = D_Pos,
         alphaAnt = alpha_Ant,
         DAnt = D_Ant)

head(allvertdata)
```

```{r}
allvertdata <-
  allvertdata %>%
  group_by(Species, Indiv) %>%
  fill(Genus, Habitat, Tip, Family, FullName, Body.Shape, .direction='downup') %>%
  ungroup()

head(allvertdata)
```

```{r}
allvertdata <-
  allvertdata %>%
  unite("Species", c("Genus", "Species")) %>%
  relocate(Species, Indiv, Habitat, Tip, Pos, CBL:DPos)

head(allvertdata)
```

```{r}
allvertdata <-
  allvertdata %>%
  mutate(across(c("CBL", "d", "alphaPos", "DPos", "alphaAnt", "DAnt"), ~ sd(., na.rm=TRUE), .names="{.col}.sd"))
```

```{r}
allvertdata_full <-
  allvertdata %>%
  group_by(Species, Indiv) %>%
  mutate_at(vars(CBL, d, alphaPos, DPos, alphaAnt, DAnt), ~ replace(.x, is.na(.x), mean(.x, na.rm=TRUE))) %>%
  mutate(CBL.n = CBL / CBL.sd,
         d.n = d / d.sd,
         alphaPos.n = alphaPos / alphaPos.sd,
         DPos.n = DPos / DPos.sd,
         alphaAnt.n = alphaAnt / alphaAnt.sd,
         DAnt.n = DAnt / DAnt.sd) %>%
  ungroup() %>%
  select(-ends_with(".sd"))

head(allvertdata_full)
```



```{r}
allvertdata_wide <-
  allvertdata_full %>%
  pivot_wider(names_from = Pos, values_from = c('CBL', 'alphaPos', 'd', 'DPos', 'alphaAnt', 'DAnt',
                                                'CBL.n', 'alphaPos.n', 'd.n', 
                                                'DPos.n', 'alphaAnt.n', 'DAnt.n'))

head(allvertdata_wide)
```

```{r}
allvertdata_widefull<- 
  allvertdata_wide %>%
  dplyr::select(-contains(c("20", "30"))) %>%
  # dplyr::select(-contains(c("40"))) %>%
  #dplyr::select(contains(c("60", "70", "80")), Habitat) %>%
  dplyr::select(starts_with("CBL.n") | starts_with("d.n") |
                  starts_with("alphaPos.n") | starts_with("DPos.n") |
                  starts_with("alphaAnt.n") | starts_with("DAnt.n"), Habitat)
```



```{r}
allvertdata_widefull
```

This was failing because your `allvertdata_widefull` data frame didn't contain the column `Habitat`. Your `select` function above just selected the CBL, d, alphaPos and DPos variables.
```{r}
allvertdata.lda <- lda(Habitat ~ ., data = allvertdata_widefull)

allvertdata.lda
```

```{r}
allvertdata_widefull %>%
  group_by(Habitat) %>%
  summarize(proportion = n() / nrow(allvertdata_widefull))
```


```{r}
allvertdata.cv <- cbind(allvertdata_widefull, as.data.frame(allvertdata.cv$class)) %>%
  rename(PredictHabitat = `allvertdata.cv$class`) %>%
  mutate(correct = Habitat == PredictHabitat)

allvertdata.cv
```

```{r}
ldadata <- predict(allvertdata.lda, newdata=allvertdata.cv)
allvertdata_withlda <- cbind(allvertdata.cv, ldadata$x)

head(allvertdata_withlda)
```

```{r}
my_theme <-
  theme_light() +
  theme(panel.border = element_blank(),
        axis.line = element_line(color="grey70"))

bdpmarkers <- c(benthic = 0, demersal = 5, pelagic = 19)
bdpcolors <- c(benthic = '#72511f', pelagic = '#53a0c9', demersal = '#ffbf00')
```


```{r fig.height=4, fig.width=6.8}
LDA_groups <- ggplot(allvertdata_withlda, aes(x=LD1, y=LD2, color=Habitat, shape=Habitat)) +
  geom_point() +
  stat_ellipse() +
  scale_shape_manual(values = bdpmarkers) +
  scale_color_manual(values = bdpcolors)
#  geom_point(data = filter(allvertdata_withlda, !correct), aes(x=LD1, y=LD2), inherit.aes = FALSE,
#             color = 'red', shape=4)

((LDA_groups) + 
    plot_layout(guides="collect")) +
  plot_annotation(tag_levels = "A") & my_theme
# ggsave('LDA.ellipse.groups.png', width=6, height=6, units="in", dpi=300)
```

```{r}
biplotdata <- as.data.frame(allvertdata.lda$scaling) %>% 
  rownames_to_column(var="var")
```

```{r}
biplotdata <-
  biplotdata %>%
  mutate(mag = sqrt(LD1^2 + LD2^2),
         varpos = var) %>%
  separate(var, into=c("var", "pos"), sep="_")
```

```{r}
biplotdata %>%

#  filter(mag < 1) %>%
#  slice_sample(n=10) %>%
  ggplot(aes(x=0, y=0, xend=LD1, yend=LD2, color=var)) +
  geom_segment(arrow = arrow(length = unit(10, "pt"))) +
  geom_label_repel(aes(x = LD1, y = LD2, label=varpos))

```


```{r}
LDA_vert <- ggpairs(allvertdata_withlda, columns = c("LD1", "LD2"),
        mapping = aes(color = Habitat, shape = Habitat),
        upper = list(continuous = "blank"),
        diag = list(continuous = "densityDiag"))
```

```{r}
ggsave("LDA_vert.png", LDA_vert, width=6, height=6, units="in")
```


This is I believe what setting up the model would look like based off of the resources I looked at. The resource I'm looking at also gives instructions to make a partition plot, which would look something like this. I'm not totally positive how applicable this is to our case, but it looks like a potential plot that could show at least something interesting.


```{r}
allvertdata_widefull %>%
#  select(starts_with(c("CBL", "d", "alphaAnt", "alphaPos", "DAnt", "DPos"))) %>%
  pivot_longer(
               cols = contains(c("CBL", "d", "alphaAnt", "alphaPos", "DAnt", "DPos")), 
               names_to = c(".value", "pos"),
               names_pattern = "(.+)_(.+)")
```

```{r}
seldata = list()

for (i in 2:6) {
  positions <- combn(seq(40, 90, by=10), i)
  
  data1 <- as_tibble(positions) %>%
    pivot_longer(names_to = "select", values_to = "positions", cols = everything()) %>%
    mutate(nselect = i) %>%
    group_by(select) %>%
    nest(positions = c("positions"))
  
  seldata <- append(seldata, list(data1))
}

seldata <- bind_rows(seldata)
```


```{r}
seldata <-
  seldata %>%
  mutate(data = map(positions, ~ select(allvertdata_widefull, contains(sapply(., as.character)), "Habitat"))) %>%
  mutate(lda = map(data, ~ lda(Habitat ~ ., data = .x)),
         cv = map(data, ~ lda(Habitat ~ ., data = .x, CV = TRUE)),
         predhab = map(cv, ~ .x$class))
```

```{r}
correct <- 
  seldata %>%
  unnest(c("data", "predhab")) %>%
  select(select, nselect, positions, Habitat, predhab) %>%
  group_by(select, nselect, positions) %>%
  summarize(correctfrac = sum(Habitat == predhab) / n()) %>%
  ungroup() %>%
  arrange(desc(correctfrac))

slice_head(correct)
slice_head(correct) %>% pull(positions)
```
```{r}
bestlda <-
  seldata %>%
  filter(select == "V10" & nselect == 3) %>%
  slice_head() %>%
  pull(lda)
bestlda = bestlda[[1]]

bestpred <-
  seldata %>%
  filter(select == "V10" & nselect == 3) %>%
  slice_head() %>%
  pull(predhab)
bestpred <- bestpred[[1]]

seldata1 <-
  seldata %>%
  filter(select == "V10" & nselect == 3) %>%
  slice_head() %>%
  pull(data)
seldata1 = seldata1[[1]]
```

```{r}
ldadata <- predict(bestlda, newdata=seldata1)
allvertdata_withbestlda <- cbind(seldata1, ldadata$x)
allvertdata_withbestlda <- cbind(allvertdata_withbestlda, bestpred) %>%
  mutate(correct = Habitat == bestpred)

head(allvertdata_withbestlda)
```

```{r fig.height=4, fig.width=6.8}
LDA_groups <- ggplot(allvertdata_withbestlda, aes(x=LD1, y=LD2, color=Habitat, shape=Habitat)) +
  geom_point(size = 4) +
  stat_ellipse() +
  scale_shape_manual(values = bdpmarkers) +
  scale_color_manual(values = bdpcolors) +
  geom_point(data = filter(allvertdata_withbestlda, !correct), aes(x=LD1, y=LD2), inherit.aes = FALSE,
             color = 'red', shape=4, size=2)

((LDA_groups) + 
    plot_layout(guides="collect")) +
  plot_annotation(tag_levels = "A") & my_theme
# ggsave('LDA.ellipse.groups.png', width=6, height=6, units="in", dpi=300)
```


```{r}
biplotdata <- as.data.frame(bestlda$scaling) %>% 
  rownames_to_column(var="var")
```

```{r}
biplotdata <-
  biplotdata %>%
  mutate(mag = sqrt(LD1^2 + LD2^2),
         varpos = var) %>%
  separate(var, into=c("var", "pos"), sep="_")
```

```{r}
biplotdata %>%

#  filter(mag < 1) %>%
#  slice_sample(n=10) %>%
  ggplot(aes(x=0, y=0, xend=LD1, yend=LD2, color=var)) +
  geom_segment(arrow = arrow(length = unit(10, "pt"))) +
  geom_label_repel(aes(x = LD1, y = LD2, label=varpos))

```