---
title: "Test phylogeny"
output: html_notebook
---

```{r}
library(tidyverse)
library(phytools)
library(here)
library(ape)
library(geiger)
library(nlme)
```

```{r}
treefile <- '12862_2017_958_MOESM2_ESM.tre'
```

```{r}
tree <- read.tree(here('..', treefile))
```

This is our giant tree of all bony fishes.
```{r}
plotTree(tree)
```

Extract a data frame with the genus and species of each tip node in the tree.
```{r}
# first just get the tip labels. These look Family_Genus_Species_Code
allspecies <- as.data.frame(tree$tip.label, stringsAsFactors = FALSE) 
colnames(allspecies) <- c('FullName')

# split the label into columns on the underscores, but then merge genus and species again into
# a binomial separated by a space
allspecies <- 
  allspecies %>% separate(FullName, sep='_', into=c('Family', 'Genus', 'Species'), extra='drop')

# add in the tip number, which is just 1 to the number of species
allspecies$Tip <- seq_len(nrow(allspecies))
```

Load in Dana's measurements
```{r}
vertmeasfile <- here('..','Merged Data','VertMeasurements_Shape-Habitat.csv')
vertmeas <- read.csv(vertmeasfile, as.is=c(1))
```

```{r}
vertmeas
```

Get distinct species names and just extract the binomial
```{r}
distinct(vertmeas, Species) %>%
  separate(Species, sep='_', into=c("Genus", "Species")) ->
  vertmeas.species
```

Then join the big data set with Dana's data, matching by binomial
```{r}
vertmeas.species <- left_join(vertmeas.species, allspecies, by=c("Genus", "Species"))
vertmeas.species
```

```{r}
left_join(filter(vertmeas.species, is.na(Tip)),
          distinct(allspecies, Genus, .keep_all=TRUE), by=c("Genus")) %>%
  transmute(Genus=Genus, Species=Species.x, Family=Family.y, MatchSpecies=Species.y, Tip=Tip.y) ->
  vertmeas.bygenus
```

```{r}
vertmeas.species[is.na(vertmeas.species$Tip),]$Family <- vertmeas.bygenus$Family
vertmeas.species[is.na(vertmeas.species$Tip),]$MatchSpecies <- vertmeas.bygenus$MatchSpecies
vertmeas.species[is.na(vertmeas.species$Tip),]$Tip <- vertmeas.bygenus$Tip

vertmeas.species
```

A number of species are missing from the big phylogeny, so we'll need to do those at family level.
*Dana* Fill in families into your data file

Now this pulls just the species that are in Dana's measurements out of the big phylogeny.
```{r}
verttree <- keep.tip(tree, tip=na.omit(as.vector(vertmeas.species$Tip)))
```

And this plots it!
```{r}
plotTree(verttree)
```

#PGLS Analysis Attempt 
(using https://lukejharmon.github.io/ilhabela/instruction/2015/07/03/PGLS/ as a reference for the code and the PGLS process)

Try with PICs to see if it works (using same process as website tutorial)
```{r}
d_an <- vertmeas[,"d"]
CBL_an <- vertmeas[,"CBL"]

names(d_an) <- names(CBL_an) <- rownames(vertmeas)

dPIC <- pic(d_an, verttree)
CBLPIC <- pic(CBL_an, verttree)

d_CBLPIC_model <- lm(dPic ~ CBLPIC - 1)

summary(d_CBLPIC_model)
```

Check correlation between notochordal foramen diameter and CBL
```{r}
plot(vertmeas, c("d", "CBL"))
```
(unsure why this isn't working -- ask about this)

Analyze notochordal foramen diameter and CBL correlation
```{r}
pgls_d_CBL<- gls(d ~ CBL, correlation = corBrownian(phy = verttree),
                      data = vertmeas, method = "ML")
summary(pgls_d_CBL)
```


#Putting the code with the process in, regardless of whether it works (will fix once I figure out the problem)

```{r}
coef(pgls_d_CBL)
```

```{r}
plot(d_an ~ CBL_an)
abline(a = coef(pgls_d_CBL)[1], b = coef(pgls_d_CBL) [2])
```







