---
title: "get_fish_info"
output: html_notebook
---

Documentation for rfishbase: (https://cran.r-project.org/web/packages/rfishbase/vignettes/tutorial.html)

# Load libraries

Load the libraries we need.

```{r}
library(rfishbase)
library(tidyverse)
library(ggplot2)
```

# Test a few species

NB: Don't call the list of species `species` because that's the function we need to call in rfishbase to get information.
```{r}
fish <- c("Anoplogaster cornuta",
             "Platichthys stellatus")
```

```{r}
validate_names(fish)
```

```{r}
fishdata <- species(fish)
```

```{r}
str(fishdata)
```

```{r}
dat <- species(fish, fields=c("BodyShapeI", "DepthRangeShallow", "DepthRangeDeep", "DepthRangeComShallow", "DepthRangeComDeep", "Length", "CommonLength", "Weight", "DemersPelag"))
```

```{r}
dat
```

# Load species from CSV file
```{r}
filename <- "../Merged Data/VertMeasurements_Shape-Habitat.csv"
```

```{r}
vertmeas <- read.csv(filename, colClasses = c("Species"="character"))

vertmeas
```

```{r}
str(vertmeas)
```

```{r}
#Idea for removing underscores, looked at https://swcarpentry.github.io/r-novice-inflammation/11-supp-read-write-csv/index.html

vertmeas <- mutate(vertmeas,
                   Species = sub("_", " ", Species)) #ifelse(as.character(Species)=='Alectis_ciliaris', 'Dana', as.character(Species)))
# vertmeas$Species <- as.factor(vertmeas$Species)
```

```{r}
vertmeas$Species
```

```{r}
fish <- vertmeas %>% distinct(Species)
```

```{r}
fish$Species
```

New challenge: Find the missing species and correct them
Missing: Roeboides affinis (on Fishbase), Stenobrachius leucopsaurus (on Fishbase), Onchorhyncus gorbuscha (not working), Ammodytes personatus (on Fishbase), Anoplarchus pupurescens (misspelled)

--> maybe because not all indicated data points we want are there for these species

```{r}
validate_names(fish$Species)
```

```{r}
fishbasedata <- species(fish$Species, fields=c("BodyShapeI", "DepthRangeShallow", "DepthRangeDeep", "DepthRangeComShallow", "DepthRangeComDeep", "Length", "CommonLength", "Weight", "DemersPelag"))
```

```{r}
fishbasedata
```


```{r}
str(fishbasedata)
```

```{r}
fishbasedatamergeddepth <- fishbasedata %>%
  mutate(newdepthrangeshallow = replace(DepthRangeComShallow,
                           is.na(DepthRangeComShallow),DepthRangeShallow),
         newdepthrangedeep = replace(DepthRangeComDeep,
                          is.na(DepthRangeComDeep),DepthRangeDeep))
fishbasedatamergeddepth
```

```{r}
write.csv(fishbasedatamergeddepth, "fishbasedata_mergeddepth.csv")
```


```{r}
str(fishbasedatamergeddepth)
```


```{r}
getwd()
```


```{r}
write.csv(fishbasedata,"fishbasedata.csv")

#couldn't get it to name the rows each species name so might have to go through and put that manually but I now have that csv
#called fishbasedata.csv
#manually named each column in Excel sheet called fishbasedata_measuredspecies.xlsx
```

```{r}
help(rfishbase)
```

```{r}
missingfish <- c("Roeboides affinis","Stenobrachius leucopsaurus","Ammodytes personatus")
```

```{r}
validate_names(missingfish)
```

```{r}
missingfishdata <- species(missingfish)
```

```{r}
str(missingfishdata)
```

```{r}
missingdat <- species(missingfish, fields=c("BodyShapeI", "DepthRangeShallow", "DepthRangeDeep", "DepthRangeComShallow", "DepthRangeComDeep", "Length", "CommonLength", "Weight", "DemersPelag"))
```

```{r}
missingdat
```

```{r}
fishbasedata2 <- cbind(fish, fishbasedatamergeddepth)
```

```{r}
left_join(
  vertmeas %>% select(Species, Indiv, SL, Pos, CBL, d, alpha_Pos, D_Pos, alpha_Ant, D_Ant) %>%
  pivot_wider(names_from = Pos, values_from = c("CBL", "d", "alpha_Pos", "D_Pos", "alpha_Ant", "D_Ant")),
  
  fishbasedata2,
  
  by = "Species")
```

```{r}
vertmeasmean <- vertmeas %>%
  group_by(Species, Indiv) %>%
  select(SL, CBL, d, alpha_Pos, alpha_Ant, D_Pos, D_Ant) %>%
  summarize_all(mean) %>%
  ungroup()

vertmeasmean
```

```{r}
vertmeasmeans_fishbase <-
  left_join(
  vertmeasmean,
  
  fishbasedata2,
  
  by = "Species")
```

```{r}
CBL_mean <- vertmeas %>%
  group_by(Species) %>% 
  summarize(CBL_mean = mean(CBL), d_mean = mean(d))
d_mean <- vertmeas %>%
  group_by(Species) %>% 
  summarize(mean(d))
alpha_Pos_mean <- vertmeas %>%
  group_by(Species) %>% 
  summarize(mean(alpha_Pos))
D_Pos_mean <- vertmeas %>%
  group_by(Species) %>% 
  summarize(mean(D_Pos))
alpha_Ant_mean <- vertmeas %>%
  group_by(Species) %>% 
  summarize(mean(alpha_Ant))
D_Ant_mean <- vertmeas %>%
  group_by(Species) %>% 
  summarize(mean(D_Ant))

fishbaseprelim <- c(CBL_mean, d_mean, alpha_Pos_mean, D_Pos_mean, alpha_Ant_mean, D_Ant_mean)

fishbaseprelim
```

```{r}
write.csv(fishbaseprelim, "vertmeasmeans.csv")
```

```{r}
fishbasedataprelim <- read.csv("fishbasedata_measuredspecies.csv")
```


```{r}
fishbaseprelim <- read.csv("vertmeasmeans.csv")

fishbaseprelim
```

```{r}
fishbasedatamergeddepth <- read.csv("fishbasedata_mergeddepth.csv")
```


```{r}
vertmeasmeans_fishbase <- left_join(fishbaseprelim,fishbasedatamergeddepth, by = "Species")

vertmeasmeans_fishbase
```

TO DO: Write text for exploratory plots and save out vertmeasmeans_fishbase

```{r}
write.csv(vertmeasmeans_fishbase, "vertmeasmeans_fishbase.csv")
```


```{r}
ggplot(vertmeasmeans_fishbase, aes(x = CBL, y = d, color = DemersPelag)) +
       geom_point()
  # facet_wrap(~ DemersPelag)
```
Here there seems to be a positive relationship with only some subsets of the DemersPelag category with these species. Mainly the demersal seem to have a positive relationship between the CBL and d, as well as some of the benthopelagic species. 


```{r}
ggplot(vertmeasmeans_fishbase, aes(x = d, y = D_Pos, color = Length)) +
       geom_point() 
#facet_wrap(~Length)
```
Here there does not seem to be as much of a trend, because the lengths of these fish are more variable than a category like DemersPelag or depth range. However, some of the shorter fish species do seem to have a positive relationships with d and D_Pos, but this trend is hard to tell for sure. 


```{r}
ggplot(vertmeasmeans_fishbase, aes(x = d, y = alpha_Pos, color = newdepthrangedeep)) + geom_point() 
#facet_wrap(~newdepthrangedeep)
```
In this plot, generally d and alpha_Pos seem to have a positive relationship when categorized by the deepest limits of their depth range (this column being the merged common and full depth range value columns). This trend seems to be more readily seen with the fish for which the depth range data were unavailable. 


```{r}
ggplot(vertmeasmeans_fishbase, aes(x = CBL, y = D_Ant, color = BodyShapeI)) + geom_point()
```
Unsure of why it removed this many rows... Still displays a positive relationships between CBL and D_Ant for all body shape types present. This trend is most easily seen with the "short and/or deep" body shape.


```{r}
ggplot(vertmeasmeans_fishbase, aes(x = d, y = D_Pos, color = DemersPelag)) + geom_point()
```
Here, there also seems so be somewhat of a positive relationship between d and D_Pos when colored by DemersPelag. This positive relationship looks steepr with the reef-associated category than with the demersal group, but both seem to exhibit somewhat of a positive relationship.

```{r}
ggplot(vertmeasmeans_fishbase, aes(x = d, y = alpha_Pos, color = Weight)) + geom_point()
```
Here there is a positive relationship between d and alpha_Pos, but there are many N/A in the weight data, but the lighter fish still had a positive relationship with alpha_Pos and d. 

```{r}
ggplot(vertmeasmeans_fishbase, aes(x = d, y = CBL, color = BodyShapeI)) + geom_point() 
#facet_wrap(~BodyShapeI)
```
Here there is less of a positive relationship between the CBL and d for some of these species. The only category that seems to display this positive relationship is the eel-like body shape. CBL



