---
title: "PGLS analysis on vertebrae"
output: html_notebook
---


```{r setup}
library(tidyverse) # for everything
library(geomorph) # for PGLS analysis
#library(emmeans) # doesn't work with geomorph
library(ggbeeswarm) # shows beeswarm points
library(ggpubr) # for effect size brackets
library(phytools) # for loading phylogenies
library(rstatix)
library(esvis)  # for effect sizes
library(Hmisc) # for simple points with confidence limits
library(patchwork) # for tiling figure panels
library(gt) # for making nice tables
library(here) # for locating data
```

Package details

```{r}
R.version.string
```

```{r}
citation()
```
```{r}
citation('geomorph')
```
```{r}
packageVersion('geomorph')
packageVersion('rrpp')
```

```{r}
citation('esvis')
```

```{r}
packageVersion('esvis')
```

# Load data

## Summary data

These data tables have means for each species, plus the pruned phylogenetic tree.

```{r}
vertdata_sp <- read_csv(here('output/vertdata_summary_lm_species.csv')) |> 
  mutate(Habitat = factor(Habitat, levels = c('benthic', 'demersal', 'pelagic')))
verttree <- readRDS(here('output/vert_tree.rds'))
```

## Vertebral measurements

```{r}
vertdata <- read_csv(here('output', "MasterVert_Measurements_Matched.csv")) %>%
  separate(MatchSpecies, into=c("MatchGenus", "MatchSpecies"), sep="_") %>%
  relocate(MatchGenus, MatchSpecies, .after=Species) %>%
  rename(alphaPos = alpha_Pos,
         alphaAnt = alpha_Ant,
         DPos = D_Pos,
         DAnt = D_Ant,
         BodyShape = `Body Shape`,
         dBW = d_BW,
         DAntBW = D_Ant_BW,
         DPosBW = D_Pos_BW,
         fineness = `SL/Max_BW`)

head(vertdata)
```

# Tests on means

## Construct the geomorph data frame

`geomorph` requires a sort of weird version of the data frame, including multidimensional arrays with dimensions labeled according to the species name. This constructs the data frame containing the variables we're interested in.

```{r}
vars <- c('CBL_mn', 'd_mn', 'alphaAnt_mn', 'alphaPos_mn', 'DAnt_mn', 'DPos_mn',
         'fineness', 'Habitat')

gdf <- geomorph.data.frame(phy = verttree)
for (v in vars) {
  arr = array(vertdata_sp[[v]], dim = c(nrow(vertdata_sp), 1),
              dimnames = list(vertdata_sp$FullName, NULL))
  gdf[[v]] <- arr
}
```


# Check fineness

How does fineness depend on habitat?

```{r}
ggplot(vertdata_sp, aes(x = Habitat, y = fineness, color = Habitat, shape = Habitat)) +
  geom_quasirandom(width=0.3, alpha = 0.5) +
  stat_summary(fun.data = 'mean_cl_boot') +
  stat_summary(aes(group = 1), fun = 'mean', geom='line', color='black') +
  labs(y = "Fineness") +
  scale_x_discrete(labels = c("b", "d", "p")) +
  scale_shape_manual(values = c(15, 19, 4)) +
  scale_color_manual(values = c(benthic="chocolate4", demersal = "gold", pelagic = "deepskyblue2")) +
  theme_bw() + theme(aspect.ratio = 0.7)
```


```{r}
fineness_habitat <- procD.pgls(fineness ~ Habitat, phy = phy, data = gdf, iter = 999, 
                               SS.type = 'III', print.progress = FALSE)
```

```{r}
summary(fineness_habitat)
```
No significant difference in fineness relative to habitat.


# Multivariate ANOVA

Putting all of our measurements together, is there a difference relative to habitat or fineness?

```{r}
manova.pgls <- procD.pgls(as.matrix(cbind(CBL_mn, d_mn, alphaAnt_mn, alphaPos_mn, DAnt_mn, DPos_mn))
                     ~ Habitat + fineness, phy = phy, data = gdf, iter = 999, SS.type = 'III',
                     print.progress = FALSE)
```

```{r}
manova.pgls <- RRPP::manova.update(manova.pgls, tol = 0, print.progress = FALSE)
```


```{r}
manova.sum <- summary(manova.pgls, test = 'Pillai')
manova.sum
```


# Multivariate tests on individual vertebrae

Get the most common value
```{r}
mode <- function(x) {
   return(as.numeric(names(which.max(table(x)))))
}
```

Pull out the landmarks for each vertebra and scale each to body length.
```{r}
vertdatapts <-
  vertdata |> left_join(select(vertdata_sp, Species, Tip, FullName), 
                      by = "Species") |> 
  filter(Indiv == 1) |> 
  select(Habitat, Pos, starts_with('Pt'), fineness, SL, Tip, FullName) |> 
  pivot_longer(cols = starts_with('Pt'),
               names_to = c('point', '.value'),
               names_pattern = "Pt(.)(.)") |> 
  mutate(x = x/SL,
         y = y/SL)
  
```

Read in the phylogenetic tree.
```{r}
tree <- read.tree(here('data/12862_2017_958_MOESM2_ESM.tre'))
```

Get species that have the same number of vertebrae digitized.
```{r}
vertdatapts <-
  vertdatapts |> 
  filter(Pos %in% seq(40,90, by = 10) & !is.na(Tip)) |> 
  group_by(FullName) |> 
  mutate(npts = sum(!is.na(x))) |> 
  ungroup() |> 
  filter(npts == mode(npts))
  
```

Get the tip numbers for each of those species and prune the tree to just those species.
```{r}
tips <-
  vertdatapts |> 
  ungroup() |> 
  distinct(Tip) |> 
  pull(Tip) |> 
  as.vector()

verttree2 <- keep.tip(tree, tips)
```

Get the names of each species, without repeats.
```{r}
ids <-
  distinct(vertdatapts, FullName, .keep_all=TRUE)
```

```{r}
vertdatapts <-
  vertdatapts |> 
  group_by(Habitat, fineness, SL, Tip, FullName, Pos) |> 
  mutate(x = x - mean(x),
         y = y - mean(y))
```

## Construct geomorph data frames for each vertebra

This is the data frame with all of the vertebrae together.
```{r}
pts <- with(vertdatapts,
            array(data = c(x, y),
             dim = c(mode(npts), 2, nrow(ids)),
             dimnames = list(NULL, NULL, ids$FullName)))
Y.gpa <- gpagen(pts, print.progress = FALSE)

gdfall <- geomorph.data.frame(Y.gpa, phy = verttree2)
gdfall$Habitat = array(ids$Habitat, dim = c(nrow(ids), 1),
                     dimnames = list(ids$FullName, NULL))
gdfall$fineness = array(ids$fineness, dim = c(nrow(ids), 1),
                      dimnames = list(ids$FullName, NULL))
```

```{r}
pgall <- procD.pgls(coords ~ Habitat + fineness, phy = phy,
                    data = gdfall, inter = 999, SS.type = 'III',
                    print.progress = FALSE)
pgall <- RRPP::manova.update(pgall, tol = 0, print.progress = FALSE)
```

```{r}
summary(pgall, test = 'Pillai')
```

Pull out vertebrae at 40%, 50%, etc and construct the data frame for each one separately.
```{r}
gdf.vert1 <- list()
selpts <- seq(40,90, by = 10)

for (i in seq_along(selpts)) {
  # print(selpts[[i]])
  v1 <- vertdatapts |> 
    filter(Pos == selpts[[i]] & !is.na(Tip)) |> 
    group_by(FullName) |> 
    mutate(n1 = n())
  
  if (any(v1$n1 != mode(v1$n1))) stop('Bad!') 
  
  # print(v1 |> select(Pos, x,y) |> head())
  pts <- array(data = c(v1$x, v1$y),
          dim = c(mode(v1$n1), 2, nrow(ids)),
             dimnames = list(NULL, NULL, ids$FullName))
  Y.gpa1 <- gpagen(pts, print.progress = FALSE)
  # print(head(Y.gpa1$consensus))
  
  gdf1 <- geomorph.data.frame(Y.gpa1, phy = verttree2)
  gdf1$Habitat <- array(ids$Habitat, dim = c(nrow(ids), 1),
                       dimnames = list(ids$FullName, NULL))
  gdf1$fineness <- array(ids$fineness, dim = c(nrow(ids), 1),
                        dimnames = list(ids$FullName, NULL))
  gdf.vert1[[i]] <- gdf1
}
```

Run the multivariate PGLS tests for each vertebra.
```{r}
pgls.vert1 <- list()
for (i in seq_along(gdf.vert1)) {
  pg1 <- procD.pgls(coords ~ Habitat + fineness, phy = phy, 
                    data = gdf.vert1[[i]],
                    iter = 999, SS.type = 'III',
                    print.progress = FALSE)
  pgls.vert1[[i]] <- pg1
  pgls.vert1[[i]] <- RRPP::manova.update(pg1, tol = 0, print.progress = FALSE)
}
```

```{r}
all.summaries <- purrr::map(pgls.vert1, ~ summary(.x, test = 'Pillai'))
```

```{r}
manovatabs <-
  purrr::map2(all.summaries, selpts, ~ .x$stats.table |> 
              mutate(var = as.character(.y)) |> 
              rownames_to_column(var = 'Effect')) |> 
  bind_rows()

manovatabs
```



```{r}
manova.all.sum <- summary(pgall, test = 'Pillai')

manovatabsall <-
  manova.all.sum$stats.table |> 
  as.data.frame() |> 
  rownames_to_column(var = 'Effect') |> 
  mutate(var = 'All vertebrae') |> 
  bind_rows(manovatabs)

manovatabsall
```

```{r}
manovatab <-
  manovatabsall |> 
  rename(p = `Pr(>Pillai)`) |> 
  select(var, Effect, Df, Pillai, Z, p) |> 
  filter(Effect %in% c('Habitat', 'fineness', 'Habitat:fineness')) |> 
  group_by(var) |> 
  gt(
    groupname_col = "var",
    rowname_col = "Effect"
  ) |> 
  fmt_number(
    columns = c("Pillai", "Z"),
    suffixing = FALSE,
    n_sigfig = 2
  ) |> 
  fmt_number(
    columns = "p",
    decimals = 3
  ) |> 
  cols_label(
    var = md("Location"),
    p = md("p"),
  ) |> 
  tab_style(
    locations = cells_column_labels(columns = c("var", 'Df', 'Pillai', 'Z', "p")),
    style = cell_text(v_align = "middle",
                      align = "center")
  ) |> 
  tab_stubhead("Location") |> 
  tab_style(
    locations = cells_stubhead(),
    style = cell_text(v_align = "middle")
  ) |> 
  sub_missing(columns = 3:6,
              missing_text = "")  

manovatab
```

```{r}
gtsave(manovatab, here("output/manova_table.rtf"))
```

## MANOVA for mean measurements

```{r}
manova.means <- procD.pgls(cbind(CBL_mn, d_mn, alphaAnt_mn, alphaPos_mn,
                               DAnt_mn, DPos_mn) ~ Habitat + fineness,
                           phy = phy, data = gdf, iter = 999, SS.type = 'III',
                           print.progress = FALSE)
manova.means <- RRPP::manova.update(manova.means, tol = 0, print.progress = FALSE)
```

```{r}
summary(manova.means, test = 'Pillai')

```

# Univariate tests

Test each measurement separately.

```{r}
models <- list(CBL_mn = procD.pgls(CBL_mn ~ Habitat + fineness, phy = phy, data = gdf, 
                                   iter = 999, SS.type = 'III', print.progress = FALSE),
            d_mn = procD.pgls(d_mn ~ Habitat + fineness, phy = phy, data = gdf, 
                              iter = 999, SS.type = 'III', print.progress = FALSE),
            alphaAnt_mn = procD.pgls(alphaAnt_mn ~ Habitat + fineness, phy = phy, data = gdf, 
                                     iter = 999, SS.type = 'III', print.progress = FALSE),
            alphaPos_mn = procD.pgls(alphaPos_mn ~ Habitat + fineness, phy = phy, data = gdf, 
                                     iter = 999, SS.type = 'III', print.progress = FALSE),
            DAnt_mn = procD.pgls(DAnt_mn ~ Habitat + fineness, phy = phy, data = gdf, 
                                 iter = 999, SS.type = 'III', print.progress = FALSE),
            DPos_mn = procD.pgls(DPos_mn ~ Habitat + fineness, phy = phy, data = gdf, 
                                 iter = 999, SS.type = 'III', print.progress = FALSE))
```

```{r}
habdf <- with(vertdata_sp,
               expand_grid(Habitat = levels(Habitat)))
finedf <- with(vertdata_sp,
               expand_grid(fineness = pracma::linspace(min(fineness), max(fineness), n = 10)))
```


```{r}
anovatabs <- c()
predvals <- tibble(var = names(models),
                   data = list(list()))
for (i in seq_along(models)) {
  print(names(models)[i])
  tab1 <- data.frame(models[[i]]$aov.table)
  tab1$var <- names(models)[i]
  anovatabs[[i]] <- tab1 |> 
    rownames_to_column(var = 'Effect') |> 
    rename(p = Pr..F.)
  
  phab <- anovatabs[[i]] |> 
    filter(Effect == 'Habitat') |> 
    pull(p)
  pfine <- anovatabs[[i]] |> 
    filter(Effect == 'fineness') |> 
    pull(p)
  
  if (phab < 0.05) {
    pred1 <- predict(models[[i]], newdata = habdf)
  
    pred1df <- habdf
    pred1df$pred <- as.vector(pred1$mean)
    
    predvals$data[[i]] <- pred1df
  } else if (pfine < 0.05) {
    pred1 <- predict(models[[i]], newdata = finedf)
  
    pred1df <- finedf
    pred1df$pred <- as.vector(pred1$mean)
    predvals$data[[i]] <- pred1df
  }
}

anovatabs <- bind_rows(anovatabs) 
anovatabs
```

```{r}
anovatabs <-
  anovatabs |> 
  bind_rows(
    data.frame(fineness_habitat$aov.table) |> 
      mutate(var = 'fineness') |> 
      rownames_to_column(var = 'Effect') |> 
      rename(p = Pr..F.)
  )
```

## Construct effect sizes

```{r}
effectsizes <-
  vertdata_sp |> 
  select(Habitat, Species, d_mn, CBL_mn, alphaPos_mn, alphaAnt_mn, DPos_mn, DAnt_mn) |> 
  group_by(Habitat, Species) |> 
  pivot_longer(cols = c(d_mn, CBL_mn, 
                        alphaPos_mn, alphaAnt_mn, DPos_mn, DAnt_mn),
               names_to = 'var') |> 
  ungroup() |> 
  nest(data = c(Habitat, Species, value)) |> 
  mutate(eff = purrr::map(data, ~ esvis::hedg_g(.x, value ~ Habitat))) |> 
  select(-data) |> 
  unnest(eff) |> 
  mutate(Habitat_ref = factor(Habitat_ref, levels = levels(vertdata_sp$Habitat)),
         Habitat_foc = factor(Habitat_foc, levels = levels(vertdata_sp$Habitat))) |> 
  filter(as.integer(Habitat_ref) > as.integer(Habitat_foc)) |> 
  mutate(Habitat = Habitat_ref,
         var = str_remove(var, '_mn')) |> 
  rename(group1 = Habitat_ref,
         group2 = Habitat_foc,
         eff = hedg_g)
```

```{r}
write_csv(effectsizes, here('output/effectsizes.csv'))
```

Rearrange the table
```{r}
effectsizes_wide <- 
  effectsizes |> 
  mutate(contrast = str_c(group1, group2, sep = ' - '),
         contrast = str_replace(contrast, '(\\w+) - (\\w+)', '\\1_\\2')) |> 
  select(var, contrast, eff) |> 
  pivot_wider(names_from = contrast, values_from = eff,
              names_glue = '{contrast}_{.value}') |> 
  mutate(var = str_c(var, '_mn'),
         Effect = 'Habitat') 

effectsizes_wide
```

```{r}
anovatabs <-
  anovatabs |> 
  left_join(effectsizes_wide, by = c('var', 'Effect'))
```

```{r}
write_csv(anovatabs, here("output/anovatabs.csv"))
```


## Make the stats table

```{r}
anovatab <-
  anovatabs |> 
  select(var, Effect, Df, Rsq, F, Z, p, ends_with('eff')) |> 
  filter(Effect %in% c('Habitat', 'fineness')) |> 
  mutate(var = str_remove(var, '_mn')) |> 
  mutate(var = case_when(
    var == "alphaAnt"   ~   "Anterior cone angle",
    var == "alphaPos"   ~   "Posterior cone angle",
    var == "CBL"   ~   "Centrum body length",
    var == "DAnt"   ~   "Anterior cone diameter",
    var == "DPos"   ~   "Posterior cone diameter",
    var == "d"   ~   "Foramen diameter",
    var == "fineness"   ~   "Fineness"
  )) |> 
  #group_by(var) |> 
  gt(
    # groupname_col = "var",
    rowname_col = "Effect"
  ) |> 
  fmt_number(
    columns = c("F", "Z"),
    suffixing = FALSE,
    n_sigfig = 2
  ) |> 
  fmt_number(
    columns = "p",
    decimals = 3
  ) |> 
  fmt_number(
    columns = "Rsq",
    decimals = 2
  ) |> 
  fmt_number( 
    columns = c('demersal_benthic_eff', 'pelagic_benthic_eff', 'pelagic_demersal_eff'),
    # columns = c("benthic_demersal_eff", "benthic_pelagic_eff", "demersal_pelagic_eff"),
    decimals = 2,
    force_sign = TRUE
  ) |> 
  cols_label(
    var = md("Measurement"),
    p = md("p"),
    demersal_benthic_eff = md("b - d"),
    pelagic_benthic_eff = md("b - p"),
    pelagic_demersal_eff = md("d - p")
  ) |> 
  tab_style(
    locations = cells_column_labels(columns = c("var", 'Df', 'Rsq', 'F', 'Z', "p")),
    style = cell_text(v_align = "middle",
                      align = "center")
  ) |> 
  #tab_stubhead("Measurement") |> 
  tab_style(
    locations = cells_stubhead(),
    style = cell_text(v_align = "middle")
  ) |> 
  # tab_spanner(
  #   label = "Effect sizes",
  #   columns = c("benthic_demersal_eff", "benthic_pelagic_eff", "demersal_pelagic_eff")
  # ) |> 
  sub_missing(columns = 2:10,
              missing_text = "")
  
anovatab
```

```{r}
gtsave(anovatab, here("output/anova_table.rtf"))
```



